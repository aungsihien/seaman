<%- include('partials/header', { title: pageTitle }) %>

<div class="breadcrumb-container-wrapper bg-light py-2 border-bottom mb-5">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/">ပင်မစာမျက်နှာ</a></li>
                <li class="breadcrumb-item"><a href="/department/waterways"><%= greatGreatGrandparentDepartmentName %></a></li>
                <li class="breadcrumb-item"><a href="/department/waterways/flag-state-survey"><%= greatGrandparentSubSectionName %></a></li>
                <li class="breadcrumb-item"><a href="/department/waterways/flag-state-survey/international-vessels"><%= grandparentNestedSectionName %></a></li>
                <li class="breadcrumb-item"><a href="/department/waterways/flag-state-survey/international-vessels/initial-renewal-annual"><%= parentServiceName %></a></li>
                <li class="breadcrumb-item active" aria-current="page"><%= pageTitle %></li>
            </ol>
        </nav>
    </div>
</div>

<div class="container mt-4">
    <h2 class="department-title"><%= pageTitle %></h2>
    <p class="lead">ဤဝန်ဆောင်မှုအတွက် လိုအပ်သော အချက်အလက်များကို ရွေးချယ်ပါ။ တန်ချိန်နေရာတွင် နံပါတ်များသာ ထည့်သွင်းပါ။</p>
    <hr class="my-4">

    <form id="tcForm">
        <% items.forEach(function(item, index) { %>
            <div class="form-check mb-3">
                <input class="form-check-input fee-item" type="checkbox" 
                       value="<%= item.price === null ? 0 : item.price %>" 
                       id="item<%= index %>" 
                       data-price="<%= item.price === null ? 0 : item.price %>" 
                       <%= item.checked ? 'checked' : '' %> 
                       data-is-dynamic="<%= item.isDynamic || false %>"
                       data-multiplier="<%= item.multiplier || '' %>">
                <label class="form-check-label d-flex justify-content-between w-100" for="item<%= index %>">
                    <span class="item-description">
                        <%= item.description %>
                        <% if (item.isDynamic) { %>
                            <input type="number" class="form-control form-control-sm d-inline-block tonnage-input ms-2 me-1" style="width: 100px;" placeholder="တန်ချိန်" data-target-item-id="item<%= index %>" min="0">
                            <span> တန်ချိန် x <%= item.multiplier.toLocaleString('my-MM') %> = </span>
                        <% } %>
                    </span>
                    <% if (item.isDynamic) { %>
                        <span class="dynamic-price-display price-display">၀ ကျပ်</span>
                    <% } else { %>
                        <span class="price-display"><%= item.price.toLocaleString('my-MM') %> ကျပ်</span>
                    <% } %>
                </label>
            </div>
        <% }); %>
    </form>

    <hr class="my-4">
    <div class="d-flex justify-content-end align-items-center">
        <h4 class="me-3">စုစုပေါင်းကျသင့်ငွေ:</h4>
        <h4 id="totalAmountDisplay" class="fw-bold price-display">၀ ကျပ်</h4>
    </div>
    
    <div class="d-flex justify-content-between mt-4 align-items-center">
        <a href="/department/waterways/flag-state-survey/international-vessels/initial-renewal-annual" class="btn btn-primary">&laquo; အရှေ့စာမျက်နှာသို့ ပြန်သွားရန် </a>
        <button type="button" class="btn btn-success" id="proceedToPaymentBtn">ငွေပေးချေမည်</button>
    </div>
</div>

<%- include('partials/payment_modals') %>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const checkboxes = document.querySelectorAll('.fee-item');
    const tonnageInputs = document.querySelectorAll('.tonnage-input');
    const totalAmountDisplay = document.getElementById('totalAmountDisplay');
    const proceedToPaymentBtn = document.getElementById('proceedToPaymentBtn');
    
    const confirmationModalEl = document.getElementById('confirmationModal');
    const successModalEl = document.getElementById('successModal');
    let confirmationModalInstance, successModalInstance;
    if (confirmationModalEl) confirmationModalInstance = new bootstrap.Modal(confirmationModalEl);
    if (successModalEl) successModalInstance = new bootstrap.Modal(successModalEl);

    const selectedItemsList = document.getElementById('selectedItemsList');
    const modalTotalAmount = document.getElementById('modalTotalAmount');
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');

    function toMyanmarNumerals(westernNumberString) {
        const myanmarNumerals = ['၀', '၁', '၂', '၃', '၄', '၅', '၆', '၇', '၈', '၉'];
        let myanmarString = '';
        if (typeof westernNumberString !== 'string') westernNumberString = String(westernNumberString);
        for (let i = 0; i < westernNumberString.length; i++) {
            const char = westernNumberString[i];
            if (char >= '0' && char <= '9') myanmarString += myanmarNumerals[parseInt(char)];
            else myanmarString += char;
        }
        return myanmarString;
    }

    function calculateTotal() {
        let total = 0;
        checkboxes.forEach(function(checkbox) {
            if (checkbox.checked) {
                if (checkbox.dataset.isDynamic === 'true') {
                    const tonnageInput = checkbox.closest('.form-check').querySelector('.tonnage-input');
                    const tonnageValue = parseInt(tonnageInput.value) || 0;
                    const multiplier = parseInt(checkbox.dataset.multiplier);
                    const itemPrice = tonnageValue * multiplier;
                    total += itemPrice;
                } else {
                    total += parseInt(checkbox.dataset.price);
                }
            }
        });
        const westernFormattedTotal = total.toLocaleString('en-US');
        totalAmountDisplay.textContent = toMyanmarNumerals(westernFormattedTotal) + ' ကျပ်';
        return total;
    }

    function updateDynamicItemPrice(tonnageInput) {
        const targetItemId = tonnageInput.dataset.targetItemId;
        const targetCheckbox = document.getElementById(targetItemId);
        const multiplier = parseInt(targetCheckbox.dataset.multiplier);
        const tonnage = parseInt(tonnageInput.value) || 0;
        const calculatedPrice = tonnage * multiplier;
        
        const displaySpan = tonnageInput.closest('label').querySelector('.dynamic-price-display');
        displaySpan.textContent = toMyanmarNumerals(calculatedPrice.toLocaleString('en-US')) + ' ကျပ်';
        calculateTotal();
    }

    tonnageInputs.forEach(function(input) {
        input.addEventListener('input', function() {
            updateDynamicItemPrice(this);
        });
        updateDynamicItemPrice(input); 
    });

    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', calculateTotal);
    });

    if (proceedToPaymentBtn) {
        proceedToPaymentBtn.addEventListener('click', function () {
            const selected = [];
            let currentTotal = 0;
            checkboxes.forEach(function(checkbox) {
                if (checkbox.checked) {
                    const label = checkbox.closest('.form-check').querySelector('.form-check-label');
                    const descriptionElement = label.querySelector('.item-description');
                    let description = '';
                    let price = 0;

                    if (checkbox.dataset.isDynamic === 'true') {
                        const tonnageInput = label.querySelector('.tonnage-input');
                        const tonnageValue = parseInt(tonnageInput.value) || 0;
                        const multiplier = parseInt(checkbox.dataset.multiplier);
                        const calculatedItemPrice = tonnageValue * multiplier;

                        description = descriptionElement.childNodes[0].nodeValue.trim() + 
                                      ` (${toMyanmarNumerals(String(tonnageValue))} တန်ချိန် x ${toMyanmarNumerals(String(multiplier))} = ${label.querySelector('.dynamic-price-display').textContent})`;
                        price = calculatedItemPrice; 
                    } else {
                        description = descriptionElement.textContent.trim();
                        price = parseInt(checkbox.dataset.price);
                    }
                    selected.push({ description, price });
                    currentTotal += price;
                }
            });

            if (selected.length === 0) {
                alert('ကျေးဇူးပြု၍ အနည်းဆုံး ဝန်ဆောင်မှုတစ်ခု ရွေးချယ်ပါ။');
                return;
            }

            selectedItemsList.innerHTML = '';
            selected.forEach(item => {
                const listItem = document.createElement('li');
                listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                const descSpan = document.createElement('span');
                descSpan.innerHTML = item.description; 
                const priceSpanModal = document.createElement('span');
                priceSpanModal.classList.add('price-display');
                priceSpanModal.textContent = toMyanmarNumerals(item.price.toLocaleString('en-US')) + ' ကျပ်';
                listItem.appendChild(descSpan);
                listItem.appendChild(priceSpanModal);
                selectedItemsList.appendChild(listItem);
            });
            
            modalTotalAmount.textContent = toMyanmarNumerals(currentTotal.toLocaleString('en-US')) + ' ကျပ်';
            if (confirmationModalInstance) confirmationModalInstance.show();
        });
    }

    if (confirmPaymentBtn) {
        confirmPaymentBtn.addEventListener('click', function () {
            if (confirmationModalInstance) confirmationModalInstance.hide();
            if (successModalInstance) successModalInstance.show();
            checkboxes.forEach(checkbox => checkbox.disabled = true);
            tonnageInputs.forEach(input => input.disabled = true);
            if (proceedToPaymentBtn) proceedToPaymentBtn.disabled = true;
        });
    }
    
    calculateTotal(); // Initial calculation
});
</script>

<%- include('partials/footer') %>
